<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Uložení GPS lokace</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.prod.css" rel="stylesheet" />

    <style>
      body {
        overscroll-behavior: contain;
        user-select: none;
      }
      .debug-console {
        font-family: monospace;
        font-size: 11px;
        height: 200px;
        overflow-y: auto;
        background: #111;
        color: #0f0;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #333;
      }
      .flash {
        animation: flash 0.2s ease-out;
      }
      @keyframes flash {
        0% {
          background: rgba(76, 175, 80, 0.3);
        }
        100% {
          background: transparent;
        }
      }
    </style>
  </head>

  <body>
    <div id="q-app"></div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.umd.prod.js"></script>

    <script>
      const { createApp, ref, onMounted, h } = Vue;

      const CUSTOM_SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
      const BUTTON_CHAR_UUID = "12345678-1234-5678-1234-56789abcdef1";

      const App = {
        setup() {
          const locations = ref([]);
          const logs = ref([]);
          const isFlashing = ref(false);
          const bleConnected = ref(false);
          const bleConnecting = ref(false);
          const bleDeviceName = ref("");
          const bluetoothAvailable = ref(false);

          let bleDevice = null;
          let bleCharacteristic = null;

          const log = (m) => {
            const time = new Date().toLocaleTimeString();
            logs.value.unshift(`${time} ${m}`);
            if (logs.value.length > 100) logs.value.pop();
            console.log(m);
          };

          const flash = () => {
            isFlashing.value = true;
            setTimeout(() => (isFlashing.value = false), 200);
          };

          const captureLocation = (trigger) => {
            log("Způsob spouštěče: " + trigger);
            flash();

            if (!navigator.geolocation) {
              log("Geolokace nedostupná!");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const d = {
                  id: Date.now(),
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                  time: Date.now(),
                  trigger,
                };
                locations.value.unshift(d);
                localStorage.setItem("gps_logs", JSON.stringify(locations.value));
                log(`✓ Lokace uložena: ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}`);
              },
              (e) => log("Chyba GPS: " + e.message),
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          };

          const openMap = (lat, lng) => {
            window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, "_blank");
          };

          const connectBLE = async () => {
            if (!bluetoothAvailable.value) return log("Web Bluetooth nepodporováno!");
            bleConnecting.value = true;

            try {
              bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ name: "GPS Shutterer" }],
                optionalServices: [CUSTOM_SERVICE_UUID],
              });

              bleDeviceName.value = bleDevice.name || "ESP32";

              const server = await bleDevice.gatt.connect();
              const service = await server.getPrimaryService(CUSTOM_SERVICE_UUID);
              bleCharacteristic = await service.getCharacteristic(BUTTON_CHAR_UUID);
              await bleCharacteristic.startNotifications();

              bleCharacteristic.addEventListener("characteristicvaluechanged", (e) => {
                const data = new Uint8Array(e.target.value.buffer);
                if (data[0] === 0x01) captureLocation("Dálkové tlačítko");
              });

              bleConnected.value = true;
              log("✓ BLE připojeno");
            } catch (e) {
              log("Chyba: " + e.message);
            } finally {
              bleConnecting.value = false;
            }
          };

          const disconnectBLE = () => {
            if (bleDevice?.gatt?.connected) bleDevice.gatt.disconnect();
            bleConnected.value = false;
            bleDevice = null;
            bleCharacteristic = null;
          };

          const clearHistory = () => {
            if (confirm("Smazat všechny lokace?")) {
              locations.value = [];
              localStorage.removeItem("gps_logs");
            }
          };

          onMounted(() => {
            bluetoothAvailable.value = !!navigator.bluetooth;
            const saved = localStorage.getItem("gps_logs");
            if (saved) locations.value = JSON.parse(saved);
          });
          const deleteLocation = (loc) => {
            Quasar.Dialog.create({
              title: "Smazat lokaci",
              message: "Opravdu chcete tuto lokaci odstranit?",
              cancel: true,
              persistent: true,
            }).onOk(() => {
              locations.value = locations.value.filter((l) => l.id !== loc.id);
              localStorage.setItem("gps_logs", JSON.stringify(locations.value));
              log("✗ Lokace smazána");
            });
          };

          return {
            locations,
            logs,
            isFlashing,
            bleConnected,
            bleConnecting,
            bleDeviceName,
            bluetoothAvailable,
            captureLocation,
            connectBLE,
            disconnectBLE,
            clearHistory,
            openMap,
            deleteLocation,
          };
        },

        render() {
          const grouped = this.locations.reduce((acc, loc) => {
            const day = new Date(loc.time).toLocaleDateString("cs-CZ", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
            (acc[day] ||= []).push(loc);
            return acc;
          }, {});

          return h(Quasar.QLayout, { view: "lHh Lpr lFf", class: this.isFlashing ? "flash" : "" }, () => [
            h(Quasar.QHeader, { elevated: true, class: "bg-primary text-white" }, () =>
              h(Quasar.QToolbar, {}, () => [
                h(Quasar.QIcon, { name: "my_location", class: "q-mr-sm" }),
                h(Quasar.QToolbarTitle, {}, () => "Ukládání GPS lokace"),
                h(Quasar.QBtn, {
                  flat: true,
                  round: true,
                  icon: "delete",
                  onClick: this.clearHistory,
                }),
              ])
            ),

            h(Quasar.QPageContainer, {}, () =>
              h(Quasar.QPage, { class: "q-pa-md" }, () => [
                h(Quasar.QCard, { class: "q-mb-md" }, () =>
                  h(Quasar.QCardSection, {}, () => [
                    h("div", { class: "text-h6 q-mb-sm" }, [h(Quasar.QIcon, { name: "bluetooth", class: "q-mr-sm" }), "Připojení k mikrokontroleru"]),

                    !this.bleConnected
                      ? h(Quasar.QBtn, {
                          color: "primary",
                          icon: "bluetooth_searching",
                          label: "Připojit se k zařízení",
                          onClick: this.connectBLE,
                          loading: this.bleConnecting,
                          disable: !this.bluetoothAvailable,
                        })
                      : h("div", { class: "text-positive" }, [
                          h(Quasar.QIcon, { name: "check_circle", class: "q-mr-xs" }),
                          ` Připojeno k ${this.bleDeviceName}`,
                          h(Quasar.QBtn, {
                            flat: true,
                            dense: true,
                            size: "sm",
                            color: "negative",
                            label: "Odpojit",
                            onClick: this.disconnectBLE,
                            class: "q-ml-sm",
                          }),
                        ]),

                    !this.bluetoothAvailable ? h("div", { class: "text-warning q-mt-sm text-caption" }, "Rozhraní Web Bluetooth nenalezeno. Použijte Chrome nebo Edge.") : null,
                  ])
                ),

                h(
                  "div",
                  { class: "debug-console q-mb-md" },
                  this.logs.map((l, i) => h("div", { key: i }, `> ${l}`))
                ),

                h("div", { class: "text-center q-mb-md" }, [
                  h(Quasar.QBtn, {
                    round: true,
                    size: "xl",
                    color: "secondary",
                    icon: "add_location",
                    onClick: () => this.captureLocation("Tlačítko na displeji mobilu"),
                  }),
                  h("div", { class: "text-caption q-mt-sm" }, "Stiskněte pro manuální uložení"),
                ]),

                Object.entries(grouped).map(([day, locs]) =>
                  h("div", { key: day, class: "q-mb-lg" }, [
                    h("div", { class: "text-h6 q-mb-sm" }, day),

                    h(Quasar.QList, { bordered: true, separator: true }, () =>
                      locs.map((loc) =>
                        h(Quasar.QItem, { key: loc.id }, () => [
                          h(Quasar.QItemSection, {}, () => [h(Quasar.QItemLabel, {}, () => `${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`), h(Quasar.QItemLabel, { caption: true }, () => `${loc.trigger} • ${new Date(loc.time).toLocaleTimeString()}`)]),
                          h(Quasar.QItemSection, { side: true }, () => [
                            h(Quasar.QBtn, {
                              flat: true,
                              round: true,
                              icon: "map",
                              color: "primary",
                              onClick: () => this.openMap(loc.lat, loc.lng),
                            }),
                            h(Quasar.QBtn, {
                              flat: true,
                              round: true,
                              color: "negative",
                              icon: "cancel",
                              onClick: () => this.deleteLocation(loc),
                            }),
                          ]),
                        ])
                      )
                    ),
                  ])
                ),
              ])
            ),
          ]);
        },
      };

      createApp(App).use(Quasar).mount("#q-app");
    </script>
  </body>
</html>


